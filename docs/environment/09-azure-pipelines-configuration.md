# Azure Pipelines Configuration

[Previous](./08-dev-machine-configuration.md) | [Home](./readme.md) | [Next](./10-url-rewrite-and-cors-configuration.md)

> In the documentation below, be sure to adjust any URLs and project names to match your environment / project.

## Configurations

If you want to create more than just the standard `development` and `production` configurations, the following will be needed:

1. Every application project will need an `environment.{environment}.ts` file defined at `client/{project}/environments`, and all of the relevant properties will need to be set.

2. For every application project in `angular.json`, a configuration representing the environment will need to be added to the following sections:

    * `{project}.architect.build.configurations`

    * `{project}.architect.serve.configurations`

3. In `package.json`, a `build:{env}:project` script will need to be created for every Angular project, to include the `core` library.

    * Example: `"build:prod:core": "ng build core --prod --configuration=production"

## Build Pipeline - CI

1. If it does not already exist, create a `.pipelines` directory in the root of the project.

2. Create a file in the convention of `{env}-pipeline.yml` and build out your build pipeline script.

    * The following is an example that performs the following:

        1. Restore server dependencies
        2. Seed the database
        3. Build the server artifacts
        4. Publish the server artifacts
        5. Install client dependencies
        6. Build the core library
        7. Build an Angular app
        8. Generate the Angular app artifacts
        9. Publish the Angular artifacts

    > In the below example, the Angular app is named playground. All tasks related to playground below should be performed for each Angular app in your project, with the `playground` name changed to the relevant app name.

    **prod-pipeline.yml**

    ```yml
    trigger:
      - main

    pool: 'build-agent'

    variables:
      buildConfiguration: 'Release'

    steps:
      - script: yarn restore
        displayName: 'Restore Server Dependencies'

      - script: dotnet run -- "Server=DEVSQL\AppSql;Database=app;Integrated Security=SSPI;Persist Security Info=true;User Id=gmsa-appsql$;"
        displayName: 'Seed Database'
        workingDirectory: 'server/dbseeder'

      - task: DotNetCoreCLI@2
        displayName: 'Build Server Release'
        inputs:
          command: publish
          publishWebProjects: true
          arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/prod/server'
          zipAfterPublish: true

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Server Artifacts'
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)/prod/server'
          artifactName: 'server'

      - script: yarn install --offline
        displayName: 'Install Client Dependencies'

      - script: yarn build:prod:core
        display: 'Build core Library'

      - script: yarn build:prod:playground
        displayName: 'Build Playground Release'

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'dist/playground'
          includeRootFolder: false
          archiveType: zip
          archiveFile: $(Build.ArtifactStagingDirectory)/playground.zip
          replaceExistingArchive: true
        displayName: 'Zip Plans Build'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Playground Artifacts'
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)/playground.zip'
          artifactName: 'playground'
    
    # Repeat the last three steps for all additional Angular apps
    ```

3. After the pipeline script is created, navigate to http://devzure.domain.net/Projets/app/_build and click **New pipeline**.

4. **Connect**: click *Azure Repos Git (YAML)*.

5. **Select**: click the project git repository.

6. **Configure**: click *Existing Azure Pipelines YAML file*.

7. **Select an existing YAML file**: Branch: *main*, Path: `/.pipelines/prod-pipeline.yml`. Click **Continue**.

8. **Review**: This step will load the configured `prod-pipeline.yml` file. Click **Run** to kick off the first build.

### Build Pipeline Details

After clicking **Run** in the above steps, an initial build will kick off.

Any time the `main` branch is updated, a new build will kick off on the CI Build pipeline.

You can access the build artifacts generated by the build by clicking the **Artifacts** button on the top right and selecting the artifact you want to download.

At any point, you can access the details of any build by navigating to http://devazure.domain.net/Projects/app/_build, then clicking into the appropriate build on the right side.

## Verify IIS Deployment Extension Installation

You may have noticed that the [IIS Server Configuration]() section did not include setting up any **App Pools** or **Sites**. This is because the CD Release Pipeline process can do this for you. Verify that the **IIS Web App Deployment Using WinRM** extension has been installed on teh Azure DevOps server by navigating to http://devazure.domain.net/Projects/_settings/extensions.

> The details of installing this extension are outlined at the start of the [DevOps Configuration Guide](./07-devops-configuration.md#iis-web-app-deployment-extension).

## Release Pipeline - CD

1. Navigate to http://devazure.domain.net/Projects/app/_release and click **New pipeline**.

2. In the **Select a template** dialog, type *Empty* in the search, then click **Apply** on the *Empty job* template.

3. In the **Stage** dialog, provide the **Stage name** based on the environment the release is configured to (in this case, *Production*), then close out the dialog using the <kbd>x</kbd> at the top right.

4. In the **Artifacts** section, click the **Add an artifact** region.

5. In the **Add an artifact** dialog, select the following settings then click the **Add** button:

    * Project: `app`
    * Source (build pipeline): `app`
    * Default version: `Latest`
    * Source alias: `_app`
    * Note the message just above the **Add** button:
        > The artifacts published by each version will be available for deployment in release pipelines. The latest successful build of **app** published the following artifacts: **server**, **playground**.

        * As the project grows and more apps are added, the amount of artifacts made available to the release pipelines will grow accordingly.

6. Click the circular lightning bold icon above the `_app` artifact ard to setup a **Continuous deployment trigger**:

    1. Under **Continuous deployment trigger**, set to **Enabled** then click **Add**.
    2. Under **Build branch** select `main` then close out by clicking the <kbd>x</kbd> at the top-right of the dialog.

7. At the top fo the pipeline next to the **All pipelines** link, rename the pipeline to `app-production`.

8. Click the **Save** button, leave **Folder** set to `\` and click **OK**.

9. Click the **Tasks** tab, select the **Agent job** task that is added by default, click **Remove** then click **Confirm** in the dialog that appears.

10. In the **Production** stage, click the menu (three horzontal dots on the right side of the card), then click **Add a deployment group job**.

11. Provide the following values:

    * Display name: `Production Deployment`
    * Deployment group: `app-iis`

12. Click the <kbd>+</kbd> button to the right of the **Production Deployment** card, type `IIS` in the search, then lick the **Add** button on the **IIS web app manage* task.

13. Click the task card and provide the following values:

    * Display name: `API Config`
    * Configuration type: `IIS Website`
    * Action: `Create or Update`
    * Website name: `api`
    * Physical Path: `%SystemDrive%\inetpub\wwwroot\api`
    * Add binding: `checked`
    * Create or update app pool: `checked`
    * Add bindings (click the menu button indicated by the three horizontal dots):
        * Protocol: `http`
        * IP Address: `10.10.100.1`
            * Replace with your IIS web server IP Address
        * Port: `80`
        * Hostname: `api.app.domain.net`
    * Name: `api`
    * .NET version: `No Managed Code`
    * Managed pipeline mode: `Integrated`
    * Identity: `Custom Account`
    * Username: `DOMAIN\gmsa-appweb$`
    * Password: ***leave blank***

14. Click the <kbd>+</kbd> button to the right of the **Production Deployment** card, type `IIS` in the search, then click the **Add** button on the *IIS web app deploy* task.

15. Click the task card and provide the following values:

    * Display name: `API Deploy`
    * Website Name: `api`
    * Package or Folder: click the menu button (indicated by three horizontal dots):
        * Select `Linked artifacts\_app (Build)\server\App.Web.zip` and click **OK**.
    * Take App Offline: `checked`

16. Repeat the same steps for each Angular application, replacing `API` (in the specified casing) with the name of the Angular app.

At this point, you should have numerous tasks (two per IIS site) configured under the **Production Deployment** deployment group job.

### Run Release Pipeline

Once the release pipeline configuration is finalized, you can deploy the app to IIS by performing the following steps:

1. Click **Create release** at the top-right of the `app-production` release pipeline at http://devazure.domain.net/Projects/app/_release

2. In the **Create a new release** dialog, click **Create**.

3. Click on the release that has been started.

4. Click the **Logs** link under the **Production** stage to see the progress of the deployment.

[Previous](./08-dev-machine-configuration.md) | [Home](./readme.md) | [Next](./10-url-rewrite-and-cors-configuration.md)