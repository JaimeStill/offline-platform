# Platform Updates

This document outlines the process of updating the dependencies and source files of this schematics project. It represents the `platform` directory specified at the beginning of the [**dependencies**](./01-dependencies.md) document.

While this repository is maintained on GitHub, transferring all of the source files to an environment with no internet connection each time there are updates can be a little bit wasteful. This process aims to minimize that waste and only provide a diff of the files that were changed between updates.

## Changelog

While going through the update process, whenever changes are made, they should be captured in a changelog that is stored at the root of the platform folder. The following is a sample changelog to illustrate the proper format:

*platform/changelog.txt*  

```txt
/
  add docs/
  add node_cache/
  add .npmrc
  add package-lock.json

  mod .editorconfig
  mod .gitignore
  mod package.json
  mod readme.md
  mod update-deps.cmd

  mov environment/ -> docs/
  mov notes.md -> docs/

  rem offline-cache/
  rem .yarnrc
  rem yarn.lock

/docs/
  mod notes.md

/src/app/
  mod index.ts

/src/workspace/files/
  update add node_cache/
  update add .npmrc
  update add package-lock.json

  update mod .editorconfig
  update mod package.json
  update mod readme.md
  update mod update-deps.cmd

  update rem .yarnrc
  update rem clean-cache.cmd
  update rem offline-cache
  update rem yarn.lock
```

From top to bottom (starting with the directory root), changes should be captured based on the directory the changes occurred in. The directories are organized hierarchically as they appear in the VS Code Explorer (or any other IDE directory tree). Indented below each directory are the sub-directories and files that have been affected All directories are post-fixed with a trailing `/` to differentiate them from files.

Each of the actions are listed in order of the action taken, with each action group organized with affected directories listed alphabetically, followed by files listed alphabetically. Actions, in organizational order, are:

* add - contents were added.
* mod - contents were modified.
* mov - contents were moved.
  * in the format of *source content* -> *destination directory*
* rem - contents were removed.

If an action is prefixed with `update`, it means that it was applied within the monorepo project generated during the [**Update Setup**](#update-setup) phase below. Any of these updates should be applied to the schematics project during the [**Integrate Changes**](#integrate-changes) phase.

If an entire directory was removed, it is assumed that all of its contents were also removed so you do not need to specify the changes within the affected directory as well.

**example**

```txt
/
  rem offline-cache
```

If an existing directory or file was moved to another directory and then modified, capture any relevant changes under the directory that it now exists in.

**example**  

```txt
/
  add docs

  mov environment -> docs
  mov notes.md -> docs

/docs/
  mod notes.md
```

If a directory was added, only capture changes within that directory if it would affect a previously existing directory or file that was moved into the new directory. 

In the above example, note that the `/docs` directory was added. Within the `/docs` directory, an `updates` directory was added (in which this document exists), as well as a `readme.md` file. The only change listed in the `/docs` section is the modification of the `notes.md` file that previously existed and was moved to `/docs`.

Updates to the project files generated by the schematics as a result of dependency updates will only affect two schematics:

* `/src/server/files`
* `/src/workspace/files`

When updating the dependencies for the project files in the [**Dependency Updates**](#dependency-updates) step below, be sure to capture the affected files in the changelog relative to the files they represent in the schematic. For instance:

Changes to `/update/package.json` would trigger the following changelog entry:

```text
/src/workspace/files
  mod package.json
```

Changes to `/update/server/Update.Web/Update.Web.csproj` would trigger the following changelog entry:

```text
/src/server/files/__name@classify__.Web
  mod __name@classify__.Web.csproj
```

When the update process has completed, this changelog will be the blueprint for the file hierarchy needed within the `platform` updates directory. Additionally, it will inform you of the modifications that need to be made to the internal platform repository, as well as any projects built with this project.

### Server Dependency Graph

To easily capture .NET projects with updated NuGet package dependencies, it's helpful to keep track of the dependencies and the dependent projects in a standardized way. At the bottom of the changelog, NuGet package dependencies should be laid out in the following format, along with the .NET projects that depend on them. This way, we can identify the project files that need to be annotated on the changelog.

```text
# Existing Package with Updated Version
NuGetPackage - CurrentVersion -> UpdatedVersion :
* Dependent .csproj

# Existing Package with No Update
NuGetPacakge - CurrentVersion :
* Dependent .csproj

# Newly Installed Package
NuGetPackage - new -> Version :
* Dependent .csproj
```

**Example**  

```txt
.NET - 6.0.0 :
Microsoft.Extensions...
System.DirectoryServices...
* Update.Identity.csproj

Automapper - new -> 11.0.1 :
* Update.Web.csproj

DocumentFormat.OpenXml - 2.16.0 :
* Update.Office.csproj

EF Core - 6.0.3 -> 6.0.5 :
* dbseeder.csproj
* Update.Auth.csproj
* Update.Core.csproj
* Update.Data.csproj

Microsoft.AspNetCore.Mvc.NetwonsoftJson - 6.0.3 -> 6.0.5 :
* Update.Web.csproj

Microsoft.AspNetCore.OData - 8.0.8 -> 8.0.10 :
* Update.Web.csproj

Microsoft.Data.SqlClient - 4.1.0 :
* Update.Sql.csproj

Newtonsoft.Json - 13.0.1 :
* Update.Core.csproj
* Update.Data.csproj
* Update.Sql.csproj

Swashbuckle.AspNetCore - 6.1.0 :
* Update.Web.csproj

System.Linq.Dynamic.Core - new -> 1.2.18 :
* Update.Web.csproj
```

The **.NET** dependency in the example above captures several libraries that stay in sync with the version of .NET.

The **EF Core** dependency in the example above represents all NuGet packages that fall under the `Microsoft.EntityFrameworkCore` library.

## Schematics Updates

1. Delete the `node_cache` and `node_modules` directories.
2. Execute the `update-deps.cmd` script.
3. Run `npm run build`.
4. Fix any schematics source files affected by the update.
5. Annotate changelog entries for any files that were affected.
    * This can be determined my checking for source control markings.

## Update Setup

1. Generate the following project using the updated schematic:

    ```bash
    schematics .:platform update --serverName=Update --debug=false --skipGit
    ```

2. Once all of the files have been generated and the npm dependencies have been installed, move the directory out of the **offline-platform** directory and open in VS Code.

    ```bash
    Move-Item .\update ..\update
    cd ..\update
    code .
    ```

## Dependency Updates

During this step, it is important to research any breaking changes between versions. The following are the most relevant changelogs to this project:

* [.NET](https://docs.microsoft.com/en-us/dotnet/core/compatibility/)
* [Angular](https://github.com/angular/angular/blob/main/CHANGELOG.md)
* [Angular Components](https://github.com/angular/components/blob/main/CHANGELOG.md)

If at any point during the build phases any errors are encountered, perform any necessary migration steps until the build is successful. Annotate changes in the changelog.

### Preparation

To ensure that there aren't any cached artifacts whenever the `nuget-packages` directory is built or whenever you're trying to test out installing dependencies offline from the cache, there is a PowerShell function I've written to clean up build artifacts.

At `$env:userprofile\Documents\PowerShell\Modules\Remove-BuildArtifacts`, create a file called `Remove-BuildArtifacts.psm1` and give it the following contents:

```PowerShell
function Remove-BuildArtifacts {
    param(
        [string[]]
        [Parameter()]
        $Artifacts = @('bin','obj','.angular','dist'),
        [string[]]
        [Parameter()]
        $Exclusions = @('node_cache', 'node_modules', 'nuget-packages')
    )

    Get-ChildItem -Include $Artifacts -Exclude $Exclusions -Recurse -Force `
        | Remove-Item -Force -Recurse
}
```

This will allow you to globally call the `Remove-BuildArtifacts` function in PowerShell.

### Server

1. Delete the `nuget-packages  directory.
2. If any additional NuGet packages are required, add them to `/server/update-deps.cmd`.
    * Annotate in changelog if modified.
3. Build out the [Server Dependency Graph](#server-dependency-graph) at the bottom of the changelog.
4. Change directory to `/server` in a terminal.
5. Execute the `clean-nuget.cmd` script.
6. Execute the `Remove-BuildArtifacts` PowerShell function.
7. Execute the `update-deps.cmd` script.
8. Capture the results of the update in the changelog either by checking the contents of the script output, or checking the updated versions in the .NET project `.csproj` files.
9. Disable the internet connection on your computer.
10. Execute the `Remove-BuildArtifacts` PowerShell function.
11. Change directory back to the project root (`cd ../`).
12. Execute `npm run restore` to ensure that the cache built correctly.
13. Execute `npm run start:server` and navigate to http://localhost:5000/swagger to ensure the server is working properly.
14. End the server process with <kbd>Ctrl + C</kbd> and turn your internet connection back on.

### Client

1. Delete the `node_cache` and `node_modules` directories, if they exist.
2. If any additional npm libraries are required, add them to `update-dep.cmd`.
    * Annotate in changelog if modified.
3. Execute the `update-deps.cmd` script.
4. Update the `package.json` dependencies in `/client/core/` to reflect the versions updated in the root `package.json`.
5. Delete the `node_modules` directory and disable the internet connection on your computer.
6. Execute the `Remove-BuildArtifacts` PowerShell function.
7. Execute `npm i --offline`.
8. Execute `npm run build` to ensure the `core` Angular library still builds properly.
9. Execute `npm run start:server` in one terminal. Open a second terminal with <kbd>Ctrl + Shift + 5</kbd> and perform the following tasks:
    1. Execute `npm run start:update` and navigate to http://localhost:3000 to ensure the `update` Angular app is working properly. End the process with <kbd>Ctrl + C</kbd>.
    2. Execute `npm run start:docs` and navigate to http://localhost:4000 to ensure the `docs` Angular app is working properly. End the process with <kbd>Ctrl + C</kbd>.
10. End the server process with <kbd>Ctrl + C</kbd> and turn your internet connection back on.
11. Annotate the following changes in the changelog:
    * /src/workspace/files/
        * node_cache/
        * package-lock.json
        * package.json
    * /src/workspace/files/client/library/package.json/
        * package.json    

## Issues

As development of a project progresses in the disconnected environment, the structure of the architecture may change, new features may be developed, or bugs that needed to be fixed may be encountered. All of these things should be captured in the [Issues](https://github.com/JaimeStill/offline-platform/issues) section of this repository so that they can be applied during the update phase.

These updates should be applied within the generated `update` monorepo project so they can be tested. Any adjustments should be annotated on the changelog and applied to the schematic project during the below [Integrate Changes](#integrate-changes) step.

## Integrate Changes

In this step, essentially, any actions in the changelog prefixed with the term `update` were applied to the generated project and now need to be applied to the schematics files. You can annotate a `*` on each action as you integrate the change to keep track of your progress, i.e.:

```txt
/src/server/files/
  * update mod nuget-packages/
```

This step is not as straightforward as you might believe. The schematics files use a special [Templating](https://github.com/angular/angular-cli/blob/main/packages/angular_devkit/schematics/README.md#templating) syntax to insert dynamic value names in both the contents of the file, as well as the file name within the file system.

> Also see [Schematics for Libraries - Add Template Files](https://angular.io/guide/schematics-for-libraries#add-template-files)

Some general guidelines:
* If a file has been removed, it is safe to remove the file in the schematics workspace as well.
* If a file or directory has been added, but is not inherently a project file (i.e. - `.gitignore`, `.editorconfig`, `node_cache`, `npm-packages`, etc.), it can be directly copied over.
* If a file has been added and is inherently a project file that would make use of any of the schema parameters (see [Workspace Schema](/src/workspace/schema.d.ts) as an example), translate those parameters using the appropriate template syntax.
* If a file has been modified, be sure that any modifications that make use of any of the schema parameters are translated to the appropriate template syntax.

When updates to `package.json` or `.csproj` files are made, more often than not, only the dependencies are being updated, so you really only need to be concerned with updating those particular sections.

The following is an exmaple of the resulting changelog entries from the updates being captured at the time of this writing:

```txt
/src/server/files/
  update mod nuget-packages/
  update mod update-deps.cmd

/src/server/files/.Auth/
  update mod .Auth.csproj

/src/server/files/.Core/
  update mod .Core.csproj

/src/server/files/.Data/
  update mod .Data.csproj

/src/server/files/.Web/
  update mod .Web.csproj

/src/server/files/dbseeder/
  update mod dbseeder.csproj

/src/workspace/files/
  update add node_cache/
  update add .npmrc
  update add package-lock.json

  update mod .editorconfig
  update mod package.json
  update mod readme.md
  update mod update-deps.cmd

  update rem .yarnrc
  update rem clean-cache.cmd
  update rem offline-cache
  update rem yarn.lock

/src/workspace/files/theme/
  update mod layout.scss
```

## Test

## Build Update Directory
