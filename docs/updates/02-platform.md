# Platform Updates

This document outlines the process of updating the dependencies and source files of this schematics project. It represents the `platform` directory specified at the beginning of the [**dependencies**](./01-dependencies.md) document.

While this repository is maintained on GitHub, transferring all of the source files to an environment with no internet connection each time there are updates can be a little bit wasteful. This process aims to minimize that waste and only provide a diff of the files that were changed between updates.

## Changelog

While going through the update process, whenever changes are made, they should be captured in a changelog that is stored at the root of the platform folder. The following is a sample changelog to illustrate the proper format:

*platform/changelog.txt*  

```txt
/
  add docs/
  add node_cache/
  add .npmrc
  add package-lock.json

  mod .editorconfig
  mod .gitignore
  mod package.json
  mod readme.md
  mod update-deps.cmd

  mov environment/ -> docs/
  mov notes.md -> docs/

  rem offline-cache/
  rem .yarnrc
  rem yarn.lock

/src/app/
  mod index.ts

/src/docs/
  mod index.ts

/src/platform/
  mod schema.json

/src/server/files/
  mod nuget-packages/
  mod update-deps.cmd

/src/workspace/
  mod index.ts
  mod schema.json

/src/workspace/files/
  add node_cache/
  add .npmrc
  add package-lock.json

  mod .editorconfig
  mod package-lock.json
  mod package.json
  mod readme.md
  mod update-deps.cmd

  rem .yarnrc
  rem clean-cache.cmd
  rem offline-cache
  rem yarn.lock
```

From top to bottom (starting with the directory root), changes should be captured based on the directory the changes occurred in. The directories are organized hierarchically as they appear in the VS Code Explorer (or any other IDE directory tree). Indented below each directory are the sub-directories and files that have been affected All directories are post-fixed with a trailing `/` to differentiate them from files.

Each of the actions are listed in order of the action taken, with each action group organized with affected directories listed alphabetically, followed by files listed alphabetically. Actions, in organizational order, are:

* add - contents were added.
* mod - contents were modified.
* mov - contents were moved.
  * in the format of *source content* -> *destination directory*
* rem - contents were removed.

If an entire directory was removed, it is assumed that all of its contents were also removed so you do not need to specify the changes within the affected directory as well.

**example**

```txt
/
  rem offline-cache
```

If an existing directory or file was moved to another directory and then modified, capture any relevant changes under the directory that it now exists in.

**example**  

```txt
/
  add docs

  mov environment -> docs
  mov notes.md -> docs

/docs
  mod notes.md
```

If a directory was added, only capture changes within that directory if it would affect a previously existing directory or file that was moved into the new directory. 

In the above example, note that the `/docs` directory was added. Within the `/docs` directory, an `updates` directory was added (in which this document exists), as well as a `readme.md` file. The only change listed in the `/docs` section is the modification of the `notes.md` file that previously existed and was moved to `/docs`.

Updates to the project files generated by the schematics as a result of dependency updates will only affect two schematics:

* `/src/server/files`
* `/src/workspace/files`

When updating the dependencies for the project files in the [**Dependency Updates**](#dependency-updates) step below, be sure to capture the affected files in the changelog relative to the files they represent in the schematic. For instance:

Changes to `/update/package.json` would trigger the following changelog entry:

```text
/src/workspace/files
  mod package.json
```

Changes to `/update/server/Update.Web/Update.Web.csproj` would trigger the following changelog entry:

```text
/src/server/files/__name@classify__.Web
  mod __name@classify__.Web.csproj
```

When the update process has completed, this changelog will be the blueprint for the file hierarchy needed within the `platform` updates directory. Additionally, it will inform you of the modifications that need to be made to the internal platform repository, as well as any projects built with this project.

### Server Dependency Graph



## Schematics Updates

1. Delete the `node_cache` and `node_modules` directories.
2. Execute the `update-deps.cmd` script.
3. Run `npm run build`.
4. Fix any schematics source files affected by the update.
5. Annotate changelog entries for any files that were affected.
    * This can be determined my checking for source control markings.

## Update Setup

1. Generate the following project using the updated schematic:

    ```bash
    schematics .:platform update --serverName=Update --debug=false --skipGit
    ```

2. Once all of the files have been generated and the npm dependencies have been installed, move the directory out of the **offline-platform** directory and open in VS Code.

    ```bash
    Move-Item .\update ..\update
    cd ..\update
    code .
    ```

## Dependency Updates

During this step, it is important to research any breaking changes between versions. The following are the most relevant changelogs to this project:

* [.NET](https://docs.microsoft.com/en-us/dotnet/core/compatibility/)
* [Angular](https://github.com/angular/angular/blob/main/CHANGELOG.md)
* [Angular Components](https://github.com/angular/components/blob/main/CHANGELOG.md)

If at any point during the build phases any errors are encountered, perform any necessary migration steps until the build is successful. Annotate changes in the changelog.

### Server

1. In the `/server` directory, open all of the `.csproj` files.
2. If any additional NuGet packages are required, add them to `/server/update-deps.cmd`.
    * Annotate in changelog if modified.
3. Build out the [Server Dependency Graph](#server-dependency-graph) a the bottom of the changelog.
3. Change directory to `/server` in a terminal and execute the `update-deps.cmd` script.
4. 

### Client

1. Delete the `node_cache` and `node_modules` directories.
2. If any additional npm libraries are required, add them to `update-dep.cmd`.
    * Annotate in changelog if modified.
3. Execute the `update-deps.cmd` script.
4. Execute `npm run build` to ensure the `core` Angular library still builds properly.
5. Execute `npm run start:docs` to ensure the `docs` Angular app is working properly.
6. Execute `npm run start:update` and navigate to http://localhost:3000 to ensure the `update` Angular app is working properly.
5. Annotate the following changes in the changelog:
    * package-lock.json
    * package.json

## Issues

## Integrate Changes

## Test

## Build Update Directory
