# Platform Updates

This document outlines the process of updating the dependencies and source files of this schematics project. It represents the `platform` directory specified at the beginning of the [**dependencies**](./01-dependencies.md) document.

While this repository is maintained on GitHub, transferring all of the source files to an environment with no internet connection each time there are updates can be a little bit wasteful. This process aims to minimize that waste and only provide a diff of the files that were changed between updates.

## Changelog

While going through the update process, whenever changes are made, they should be captured in a changelog that is stored at the root of the platform folder. The following is a sample changelog to illustrate the proper format:

*platform/changelog.txt*  

```txt
/
  add docs/
  add node_cache/
  add .npmrc
  add package-lock.json

  mod .editorconfig
  mod .gitignore
  mod package.json
  mod readme.md
  mod update-deps.cmd

  mov environment/ -> docs/
  mov notes.md -> docs/

  rem offline-cache/
  rem .yarnrc
  rem yarn.lock

/src/app/
  mod index.ts

/src/docs/
  mod index.ts

/src/platform/
  mod schema.json

/src/server/files/
  mod nuget-packages/
  mod update-deps.cmd

/src/workspace/
  mod index.ts
  mod schema.json

/src/workspace/files/
  add node_cache/
  add .npmrc
  add package-lock.json

  mod .editorconfig
  mod package-lock.json
  mod package.json
  mod readme.md
  mod update-deps.cmd

  rem .yarnrc
  rem clean-cache.cmd
  rem offline-cache
  rem yarn.lock
```

From top to bottom (starting with the directory root), changes should be captured based on the directory the changes occurred in. The directories are organized hierarchically as they appear in the VS Code Explorer (or any other IDE directory tree). Indented below each directory are the sub-directories and files that have been affected All directories are post-fixed with a trailing `/` to differentiate them from files.

Each of the actions are listed in order of the action taken, with each action group organized with affected directories listed alphabetically, followed by files listed alphabetically. Actions, in organizational order, are:

* add - contents were added.
* mod - contents were modified.
* mov - contents were moved.
  * in the format of *source content* -> *destination directory*
* rem - contents were removed.

If an entire directory was removed, it is assumed that all of its contents were also removed so you do not need to specify the changes within the affected directory as well.

**example**

```txt
/
  rem offline-cache
```

If an existing directory or file was moved to another directory and then modified, capture any relevant changes under the directory that it now exists in.

**example**  

```txt
/
  add docs

  mov environment -> docs
  mov notes.md -> docs

/docs
  mod notes.md
```

If a directory was added, only capture changes within that directory if it would affect a previously existing directory or file that was moved into the new directory. 

In the above example, note that the `/docs` directory was added. Within the `/docs` directory, an `updates` directory was added (in which this document exists), as well as a `readme.md` file. The only change listed in the `/docs` section is the modification of the `notes.md` file that previously existed and was moved to `/docs`.

Updates to the project files generated by the schematics as a result of dependency updates will only affect two schematics:

* `/src/server/files`
* `/src/workspace/files`

When updating the dependencies for the project files in the [**Dependency Updates**](#dependency-updates) step below, be sure to capture the affected files in the changelog relative to the files they represent in the schematic. For instance:

Changes to `/update/package.json` would trigger the following changelog entry:

```text
/src/workspace/files
  mod package.json
```

Changes to `/update/server/Update.Web/Update.Web.csproj` would trigger the following changelog entry:

```text
/src/server/files/__name@classify__.Web
  mod __name@classify__.Web.csproj
```

When the update process has completed, this changelog will be the blueprint for the file hierarchy needed within the `platform` updates directory. Additionally, it will inform you of the modifications that need to be made to the internal platform repository, as well as any projects built with this project.

### Server Dependency Graph

To easily capture .NET projects with updated NuGet package dependencies, it's helpful to keep track of the dependencies and the dependent projects in a standardized way. At the bottom of the changelog, NuGet package dependencies should be laid out in the following format, along with the .NET projects that depend on them. This way, we can identify the project files that need to be annotated on the changelog.

```text
# Existing Package with Updated Version
NuGetPackage - CurrentVersion -> UpdatedVersion :
* Dependent .csproj

# Existing Package with No Update
NuGetPacakge - CurrentVersion :
* Dependent .csproj

# Newly Installed Package
NuGetPackage - new -> Version :
* Dependent .csproj
```

**Example**  

```txt
.NET - 6.0.0 :
Microsoft.Extensions...
System.DirectoryServices...
* Update.Identity.csproj

Automapper - new -> 11.0.1 :
* Update.Web.csproj

DocumentFormat.OpenXml - 2.16.0 :
* Update.Office.csproj

EF Core - 6.0.3 -> 6.0.5 :
* dbseeder.csproj
* Update.Auth.csproj
* Update.Core.csproj
* Update.Data.csproj

Microsoft.AspNetCore.Mvc.NetwonsoftJson - 6.0.3 -> 6.0.5 :
* Update.Web.csproj

Microsoft.AspNetCore.OData - 8.0.8 -> 8.0.10 :
* Update.Web.csproj

Microsoft.Data.SqlClient - 4.1.0 :
* Update.Sql.csproj

Newtonsoft.Json - 13.0.1 :
* Update.Core.csproj
* Update.Data.csproj
* Update.Sql.csproj

Swashbuckle.AspNetCore - 6.1.0 :
* Update.Web.csproj

System.Linq.Dynamic.Core - new -> 1.2.18 :
* Update.Web.csproj
```

The **.NET** dependency in the example above captures several libraries that stay in sync with the version of .NET.

The **EF Core** dependency in the example above represents all NuGet packages that fall under the `Microsoft.EntityFrameworkCore` library.

## Schematics Updates

1. Delete the `node_cache` and `node_modules` directories.
2. Execute the `update-deps.cmd` script.
3. Run `npm run build`.
4. Fix any schematics source files affected by the update.
5. Annotate changelog entries for any files that were affected.
    * This can be determined my checking for source control markings.

## Update Setup

1. Generate the following project using the updated schematic:

    ```bash
    schematics .:platform update --serverName=Update --debug=false --skipGit
    ```

2. Once all of the files have been generated and the npm dependencies have been installed, move the directory out of the **offline-platform** directory and open in VS Code.

    ```bash
    Move-Item .\update ..\update
    cd ..\update
    code .
    ```

## Dependency Updates

During this step, it is important to research any breaking changes between versions. The following are the most relevant changelogs to this project:

* [.NET](https://docs.microsoft.com/en-us/dotnet/core/compatibility/)
* [Angular](https://github.com/angular/angular/blob/main/CHANGELOG.md)
* [Angular Components](https://github.com/angular/components/blob/main/CHANGELOG.md)

If at any point during the build phases any errors are encountered, perform any necessary migration steps until the build is successful. Annotate changes in the changelog.

### Server

#### Preparation

To ensure that there aren't any cached artifacts whenever the `nuget-packages` directory is built, there are a few steps that I like to take to ensure a clean cache.

At `$env:userprofile\Documents\PowerShell\Modules\Remove-BuildArtifacts`, create a file called `Remove-BuildArtifacts.psm1` and give it the following contents:

```PowerShell
function Remove-BuildArtifacts {
    param(
        [string[]]
        [Parameter()]
        $Artifacts = @('bin','obj','.angular','dist'),
        [string[]]
        [Parameter()]
        $Exclusions = @('node_cache', 'node_modules', 'nuget-packages')
    )

    Get-ChildItem -Include $Artifacts -Exclude $Exclusions -Recurse -Force `
        | Remove-Item -Force -Recurse
}
```

This will allow you to globally call the `Remove-BuildArtifacts` function in PowerShell.

#### Build Server Dependency Cache

1. Delete the `nuget-packages  directory.
2. If any additional NuGet packages are required, add them to `/server/update-deps.cmd`.
    * Annotate in changelog if modified.
3. Build out the [Server Dependency Graph](#server-dependency-graph) at the bottom of the changelog.
4. Change directory to `/server` in a terminal.
5. Execute the `clean-nuget.cmd` script.
6. Execute the `Remove-BuildArtifacts` PowerShell function.
7. Execute the `update-deps.cmd` script.
8. Capture the results of the update in the changelog either by checking the contents of the script output, or checking the updated versions in the .NET project `.csproj` files.
9. Disable the internet connection on your computer.
10. Execute the `Remove-BuildArtifacts` PowerShell function.
11. Change directory back to the project root (`cd ../`).
12. Execute `npm run restore` to ensure that the cache built correctly.
13. Execute `npm run start:server` and navigate to http://localhost:5000/swagger to ensure the server is working properly.
14. End the server process with <kbd>Ctrl + C</kbd> and turn your internet connection back on.

### Client

1. Delete the `node_cache` and `node_modules` directories, if they exist.
2. If any additional npm libraries are required, add them to `update-dep.cmd`.
    * Annotate in changelog if modified.
3. Execute the `update-deps.cmd` script.
4. Delete the `node_modules` directory and disable the internet connection on your computer.
5. Execute the `Remove-BuildArtifacts` PowerShell function.
6. Execute `npm i --offline`.
7. Execute `npm run build` to ensure the `core` Angular library still builds properly.
8. Execute `npm run start:server` in one terminal. Open a second terminal with <kbd>Ctrl + Shift + 5</kbd> and perform the following tasks:
    1. Execute `npm run start:update` and navigate to http://localhost:3000 to ensure the `update` Angular app is working properly. End the process with <kbd>Ctrl + C</kbd>.
    2. Execute `npm run start:docs` and navigate to http://localhost:4000 to ensure the `docs` Angular app is working properly. End the process with <kbd>Ctrl + C</kbd>.
9. End the server process with <kbd>Ctrl + C</kbd> and turn your internet connection back on.
10. Annotate the following changes in the changelog:
    * node_cache/
    * package-lock.json
    * package.json

## Issues



## Integrate Changes

## Test

## Build Update Directory
